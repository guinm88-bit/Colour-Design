<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plaid Master Pro</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --panel: #ffffff;
            --border: #cbd5e1;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: #1e293b;
        }

        /* STICKY PREVIEW */
        .preview-header {
            position: sticky; top: 0; z-index: 100;
            background: #fff; padding: 10px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        canvas {
            width: 180px; height: 180px;
            background: #fff; border: 1px solid #94a3b8;
            display: block; margin: 0 auto; touch-action: none;
        }
        .zoom-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; font-size: 12px; }
        input[type="range"] { width: 100px; }

        /* TABS */
        .tabs { display: flex; background: #fff; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: bold; color: #64748b; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .section { display: none; padding: 15px; max-width: 500px; margin: 0 auto; }
        .section.active { display: block; }

        /* COLOR TOOLS */
        .shades-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); 
            gap: 10px; margin: 10px 0; 
        }
        .swatch-card { position: relative; }
        .swatch { 
            width: 100%; aspect-ratio: 1/1; border-radius: 8px; 
            border: 2px solid transparent; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .swatch.active { border-color: var(--primary); transform: scale(1.05); }
        .del-shade {
            position: absolute; top: -5px; right: -5px; width: 18px; height: 18px;
            background: var(--danger); color: white; border: none; border-radius: 50%;
            font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        /* HARMONIES - RESTORED & COMPACT */
        .harmony-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-top: 12px; display: block; }
        .scroll-row { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }
        .h-swatch { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); }

        /* PATTERN TOOLS */
        .sticky-brush {
            background: #fff; padding: 10px; border-radius: 10px; 
            border: 1px solid var(--border); margin-bottom: 15px;
            position: sticky; top: 220px; z-index: 90;
        }
        .thread-row { 
            background: #fff; border: 1px solid var(--border); 
            border-radius: 10px; padding: 8px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 10px;
        }
        .apply-box { 
            width: 34px; height: 34px; border-radius: 6px; 
            border: 2px dashed #cbd5e1; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .input-group { display: flex; align-items: center; background: #f8fafc; border-radius: 6px; border: 1px solid var(--border); }
        .input-group input { width: 40px; border: none; text-align: center; font-weight: bold; background: transparent; }
        .step-btn { background: none; border: none; padding: 8px; color: var(--primary); font-weight: bold; font-size: 18px; }

        .btn-add { width: 100%; padding: 10px; border: 1px dashed var(--primary); background: none; color: var(--primary); font-weight: bold; border-radius: 8px; margin-top: 5px; }
        .btn-save { background: #1e293b; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>

<div class="preview-header">
    <canvas id="plaidCanvas" width="400" height="400"></canvas>
    <div class="zoom-container">
        <input type="range" id="zoom" min="1" max="10" value="4" oninput="render()">
        <button class="btn-save" onclick="saveImage()">Download PNG</button>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">1. Colors</div>
    <div class="tab" onclick="switchTab(1)">2. Pattern</div>
</div>

<!-- SECTION 1: COLORS -->
<div id="sec-0" class="section active">
    <div style="background:#fff; padding:12px; border-radius:12px; border:1px solid var(--border); display: flex; align-items: center; gap: 15px;">
        <input type="color" id="baseColorInput" value="#4f46e5" oninput="setBase(this.value)" style="width:50px; height:50px; border:none; border-radius:8px;">
        <div>
            <strong>Base Picker</strong><br>
            <small>Generates combinations below</small>
        </div>
    </div>

    <h3>Selected Shades</h3>
    <div id="paletteList" class="shades-grid"></div>

    <div id="harmonyContainer">
        <h3>Combinations</h3>
        <div id="harmonies"></div>
    </div>
</div>

<!-- SECTION 2: PATTERN -->
<div id="sec-1" class="section">
    <!-- QUICK BRUSH SELECTOR -->
    <div class="sticky-brush">
        <small style="font-weight: bold; color: #64748b; text-transform: uppercase;">Active Brush:</small>
        <div id="brushList" class="scroll-row"></div>
        <small style="color: #94a3b8; font-size: 11px;">Tap a shade above, then tap a thread's square to paint.</small>
    </div>

    <div style="font-size: 13px; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px;">
        <label><input type="checkbox" id="linkWeft" checked onchange="toggleWeft()"> Sync Warp/Weft</label> &nbsp;
        <label><input type="checkbox" id="mirror" checked onchange="render()"> Mirror</label>
    </div>

    <h4>Warp Threads</h4>
    <div id="warpList"></div>
    <button class="btn-add" onclick="addThread('warp')">+ Add Thread</button>

    <div id="weftGroup" style="display:none; margin-top:20px;">
        <h4>Weft Threads</h4>
        <div id="weftList"></div>
        <button class="btn-add" onclick="addThread('weft')">+ Add Thread</button>
    </div>
</div>

<script>
    let baseColor = "#4f46e5";
    let palette = ["#4f46e5", "#ffffff", "#1e293b", "#f43f5e"];
    let warp = [{ color: "#4f46e5", width: 10 }, { color: "#ffffff", width: 2 }];
    let weft = [{ color: "#4f46e5", width: 10 }, { color: "#ffffff", width: 2 }];

    const canvas = document.getElementById('plaidCanvas');
    const ctx = canvas.getContext('2d');

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === idx));
        updateUI(); 
    }

    function setBase(hex) {
        baseColor = hex;
        if (!palette.includes(hex)) palette.push(hex);
        updateUI();
    }

    function removeShade(e, hex) {
        e.stopPropagation();
        if (palette.length > 1) {
            palette = palette.filter(c => c !== hex);
            if (baseColor === hex) baseColor = palette[0];
            updateUI();
        }
    }

    function updateUI() {
        renderPalette();
        renderHarmonies();
        renderThreadLists();
        renderBrushSelector();
        render();
    }

    function renderHarmonies() {
        const container = document.getElementById('harmonies');
        container.innerHTML = '';
        const hsl = hexToHsl(baseColor);
        const schemes = {
            "Complementary": [rotateHsl(hsl, 180)],
            "Monochromatic": [lightenHsl(hsl, 25), lightenHsl(hsl, -25)],
            "Triadic": [rotateHsl(hsl, 120), rotateHsl(hsl, 240)],
            "Tetradic": [rotateHsl(hsl, 90), rotateHsl(hsl, 180), rotateHsl(hsl, 270)]
        };

        for (let type in schemes) {
            container.innerHTML += `<span class="harmony-label">${type}</span>`;
            const row = document.createElement('div');
            row.className = 'scroll-row';
            schemes[type].forEach(c => {
                const hex = hslToHex(c.h, c.s, c.l);
                const sw = document.createElement('div');
                sw.className = 'h-swatch';
                sw.style.background = hex;
                sw.onclick = () => setBase(hex);
                row.appendChild(sw);
            });
            container.appendChild(row);
        }
    }

    function renderPalette() {
        const list = document.getElementById('paletteList');
        list.innerHTML = '';
        palette.forEach(hex => {
            const active = (hex === baseColor) ? 'active' : '';
            const item = document.createElement('div');
            item.className = 'swatch-card';
            item.innerHTML = `
                <div class="swatch ${active}" style="background:${hex}" onclick="setBase('${hex}')"></div>
                <button class="del-shade" onclick="removeShade(event, '${hex}')">✕</button>
            `;
            list.appendChild(item);
        });
    }

    function renderBrushSelector() {
        const list = document.getElementById('brushList');
        list.innerHTML = '';
        palette.forEach(hex => {
            const active = (hex === baseColor) ? 'active' : '';
            const sw = document.createElement('div');
            sw.className = `h-swatch ${active}`;
            sw.style.cssText = `background:${hex}; border-radius:50%; width:35px; height:35px; border:2px solid ${active ? 'var(--primary)' : '#fff'}`;
            sw.onclick = () => { baseColor = hex; updateUI(); };
            list.appendChild(sw);
        });
    }

    function applyBrush(type, idx) {
        const target = (type === 'warp') ? warp : weft;
        target[idx].color = baseColor;
        updateUI();
    }

    function renderThreadLists() {
        ['warp', 'weft'].forEach(type => {
            const container = document.getElementById(type + 'List');
            const data = (type === 'warp') ? warp : weft;
            container.innerHTML = '';
            data.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = 'thread-row';
                row.innerHTML = `
                    <div class="apply-box" style="background:${t.color}; border-style: solid; border-color: #fff;" onclick="applyBrush('${type}', ${i})">SET</div>
                    <div class="input-group">
                        <button class="step-btn" onclick="adjustWidth('${type}', ${i}, -1)">-</button>
                        <input type="number" value="${t.width}" onchange="updateWidth('${type}', ${i}, this.value)">
                        <button class="step-btn" onclick="adjustWidth('${type}', ${i}, 1)">+</button>
                    </div>
                    <button onclick="removeThread('${type}', ${i})" style="margin-left:auto; border:none; background:none; color:var(--danger)">✕</button>
                `;
                container.appendChild(row);
            });
        });
    }

    function adjustWidth(type, i, delta) {
        const target = (type === 'warp') ? warp : weft;
        target[i].width = Math.max(1, target[i].width + delta);
        updateUI();
    }

    function updateWidth(type, i, val) {
        const target = (type === 'warp') ? warp : weft;
        target[i].width = Math.max(1, parseInt(val) || 1);
        render();
    }

    function removeThread(type, i) {
        const target = (type === 'warp') ? warp : weft;
        if(target.length > 1) target.splice(i, 1);
        updateUI();
    }

    function toggleWeft() {
        document.getElementById('weftGroup').style.display = document.getElementById('linkWeft').checked ? 'none' : 'block';
        render();
    }

    function addThread(type) {
        const target = (type === 'warp') ? warp : weft;
        target.push({ color: baseColor, width: 4 });
        updateUI();
    }

    function render() {
        const zoom = parseInt(document.getElementById('zoom').value);
        const warpSeq = getFullSeq(warp);
        const weftSeq = document.getElementById('linkWeft').checked ? warpSeq : getFullSeq(weft);
        if (!warpSeq.length || !weftSeq.length) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < canvas.width / zoom; i++) {
            for (let j = 0; j < canvas.height / zoom; j++) {
                const c1 = warpSeq[i % warpSeq.length];
                const c2 = weftSeq[j % weftSeq.length];
                ctx.fillStyle = blend(c1, c2);
                ctx.fillRect(i * zoom, j * zoom, zoom, zoom);
            }
        }
    }

    function getFullSeq(arr) {
        let s = [];
        arr.forEach(t => { for(let i=0; i<t.width; i++) s.push(t.color); });
        if (document.getElementById('mirror').checked && arr.length > 1) {
            const lastW = arr[arr.length-1].width;
            s = s.concat([...s].slice(0, -lastW).reverse());
        }
        return s;
    }

    function blend(hex1, hex2) {
        const r1 = parseInt(hex1.substr(1,2),16), g1 = parseInt(hex1.substr(3,2),16), b1 = parseInt(hex1.substr(5,2),16);
        const r2 = parseInt(hex2.substr(1,2),16), g2 = parseInt(hex2.substr(3,2),16), b2 = parseInt(hex2.substr(5,2),16);
        return `rgb(${(r1+r2)/2}, ${(g1+g2)/2}, ${(b1+b2)/2})`;
    }

    function hexToHsl(hex) {
        let r = parseInt(hex.substr(1,2),16)/255, g = parseInt(hex.substr(3,2),16)/255, b = parseInt(hex.substr(5,2),16)/255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if(max == min) h = s = 0;
        else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
    }

    function hslToHex(h, s, l) {
        l /= 100; const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }
    function rotateHsl(hsl, deg) { return { ...hsl, h: (hsl.h + deg) % 360 }; }
    function lightenHsl(hsl, amt) { return { ...hsl, l: Math.max(0, Math.min(100, hsl.l + amt)) }; }

    function saveImage() {
        const a = document.createElement("a");
        a.download = "my-plaid.png";
        a.href = canvas.toDataURL();
        a.click();
    }

    updateUI();
</script>

</body>
</html>