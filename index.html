<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plaid Master Pro</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #ffffff;
            --border: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: sans-serif;
            background: var(--bg); margin: 0; color: #333;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- PREVIEW AREA --- */
        .preview-header {
            flex-shrink: 0; background: #fff; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 2px solid #eee; z-index: 100;
        }
        canvas {
            background: #f0f0f0; width: 100%; max-width: 450px; 
            aspect-ratio: 1.6/1; border: 2px solid #333; image-rendering: pixelated;
        }

        .nav-bar {
            display: flex; justify-content: space-around; 
            width: 100%; max-width: 450px; margin: 10px 0; gap: 8px;
        }
        .nav-btn {
            flex: 1; background: var(--primary); color: white; border: none;
            padding: 10px 5px; border-radius: 4px; font-size: 12px; cursor: pointer;
            font-weight: bold; text-transform: uppercase;
        }

        #zoomCont { 
            display: none; position: absolute; background: white; padding: 15px; 
            border: 2px solid #333; z-index: 1000; top: 150px; border-radius: 8px; 
        }

        /* --- SCROLL SYSTEM --- */
        .main-scroller {
            flex: 1; display: flex; overflow-x: auto;
            scroll-snap-type: x mandatory; scroll-behavior: smooth;
        }
        .main-scroller::-webkit-scrollbar { display: none; }

        .pane {
            min-width: 100%; scroll-snap-align: start;
            padding: 20px; overflow-y: auto;
        }

        /* --- PALETTE UI --- */
        .harmony-group { text-align: center; margin-bottom: 20px; }
        .harmony-title { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .swatch-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        
        .swatch { 
            width: 42px; height: 42px; border-radius: 6px; border: 1px solid #999; 
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .swatch:active { transform: scale(0.9); }
        
        .active-palette-section { border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; }
        .del-btn { 
            position: absolute; top: -8px; right: -8px; background: #ff4444; 
            color: white; border: none; border-radius: 50%; width: 20px; height: 20px; 
            font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- THREAD UI --- */
        .thread-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .thread-col { display: flex; flex-direction: column; gap: 12px; }
        .thread-item { display: flex; align-items: center; gap: 8px; }
        .color-preview { width: 36px; height: 36px; border: 2px solid #333; border-radius: 4px; cursor: pointer; flex-shrink: 0; }
        .width-input { width: 100%; border: 1px solid #333; padding: 8px; border-radius: 4px; font-weight: bold; }

        /* DROPDOWN */
        .dd-menu {
            position: absolute; background: white; border: 2px solid #333; 
            z-index: 2000; padding: 8px; display: none; grid-template-columns: repeat(3, 1fr); gap: 8px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); border-radius: 8px;
        }

        @media (min-width: 900px) {
            .toggle-btn { display: none; }
            .main-scroller { overflow-x: hidden; }
            .pane { min-width: 50%; border-right: 1px solid #eee; }
            canvas { max-width: 700px; aspect-ratio: 2.5/1; }
        }
    </style>
</head>
<body>

<div class="preview-header">
    <canvas id="plaidCanvas" width="900" height="500"></canvas>
    
    <div class="nav-bar">
        <button class="nav-btn" onclick="toggleZoom()">Zoom</button>
        <button class="nav-btn toggle-btn" onclick="scrollToPane(0)">Palette</button>
        <button class="nav-btn toggle-btn" onclick="scrollToPane(1)">Threads</button>
        <button class="nav-btn" onclick="saveImage()">Download</button>
    </div>

    <div id="zoomCont">
        <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">PIXEL SIZE</label>
        <input type="range" id="zoom" min="2" max="50" value="15" oninput="render()">
    </div>
</div>

<div class="main-scroller" id="scroller">
    <!-- PANE 1: COLOR ENGINE -->
    <div class="pane">
        <div class="harmony-group">
            <span class="harmony-title">Base Color Picker</span>
            <div class="swatch-row" style="align-items: center; gap: 15px;">
                <input type="color" id="baseInput" value="#4a90e2" oninput="previewBase(this.value)" style="width:50px; height:50px; border:2px solid #333; border-radius:8px; cursor:pointer;">
                <button onclick="addCurrentBase()" style="padding: 10px; background: #333; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">+ ADD TO PALETTE</button>
            </div>
        </div>

        <div id="harmonyLists"></div>

        <div class="active-palette-section">
            <span class="harmony-title" style="text-align: center;">Active Palette (Click to use in threads)</span>
            <div class="swatch-row" id="paletteList" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- PANE 2: THREAD ENGINE -->
    <div class="pane">
        <div style="text-align: center; margin-bottom: 20px; background: #f0f0f0; padding: 10px; border-radius: 8px;">
            <label style="font-size: 13px; font-weight: bold; cursor: pointer;">
                <input type="checkbox" id="linkWeft" checked onchange="toggleWeft()"> Use Warp Pattern for Weft
            </label>
        </div>

        <div class="thread-grid">
            <div class="thread-col">
                <center><b style="font-size: 14px; text-transform: uppercase;">Warp</b></center>
                <div id="warpList"></div>
                <button onclick="addThread('warp')" style="padding: 8px; border: 2px dashed #ccc; background: none; cursor: pointer; border-radius: 4px;">+ Add Warp</button>
            </div>
            <div class="thread-col" id="weftCol" style="opacity: 0.3; pointer-events: none;">
                <center><b style="font-size: 14px; text-transform: uppercase;">Weft</b></center>
                <div id="weftList"></div>
                <button onclick="addThread('weft')" style="padding: 8px; border: 2px dashed #ccc; background: none; cursor: pointer; border-radius: 4px;">+ Add Weft</button>
            </div>
        </div>
    </div>
</div>

<div id="ddMenu" class="dd-menu"></div>

<script>
    let palette = ["#4A90E2", "#FFFFFF"];
    let warp = [{ color: "#4A90E2", width: 40 }, { color: "#FFFFFF", width: 10 }];
    let weft = [{ color: "#4A90E2", width: 40 }, { color: "#FFFFFF", width: 10 }];
    let currentBase = "#4A90E2";

    const canvas = document.getElementById('plaidCanvas');
    const ctx = canvas.getContext('2d');

    function scrollToPane(idx) {
        document.getElementById('scroller').scrollLeft = idx * window.innerWidth;
    }

    function toggleZoom() {
        const z = document.getElementById('zoomCont');
        z.style.display = z.style.display === 'block' ? 'none' : 'block';
    }

    function previewBase(hex) {
        currentBase = hex.toUpperCase();
        renderHarmonies(currentBase);
    }

    function addCurrentBase() {
        if (!palette.includes(currentBase)) {
            palette.push(currentBase);
            updateUI();
        }
    }

    function renderHarmonies(base) {
        const cont = document.getElementById('harmonyLists');
        cont.innerHTML = '';
        const hsl = hexToHsl(base);
        
        const types = {
            "Complimentary": [rotateHsl(hsl, 180)],
            "Monochromatic": [lightenHsl(hsl, 25), lightenHsl(hsl, -25)],
            "Analogous": [rotateHsl(hsl, -30), rotateHsl(hsl, 30)],
            "Tetradic": [rotateHsl(hsl, 90), rotateHsl(hsl, 180), rotateHsl(hsl, 270)],
            "Triadic": [rotateHsl(hsl, 120), rotateHsl(hsl, 240)]
        };

        for (let name in types) {
            const div = document.createElement('div');
            div.className = 'harmony-group';
            div.innerHTML = `<span class="harmony-title">${name}</span>`;
            const row = document.createElement('div');
            row.className = 'swatch-row';
            types[name].forEach(c => {
                const hex = hslToHex(c.h, c.s, c.l);
                const s = document.createElement('div');
                s.className = 'swatch';
                s.style.background = hex;
                s.title = "Click to add to palette";
                s.onclick = () => { if(!palette.includes(hex)) palette.push(hex); updateUI(); };
                row.appendChild(s);
            });
            div.appendChild(row);
            cont.appendChild(div);
        }
    }

    function updateUI() {
        const pList = document.getElementById('paletteList');
        pList.innerHTML = '';
        palette.forEach((hex, i) => {
            const s = document.createElement('div');
            s.className = 'swatch';
            s.style.background = hex;
            s.innerHTML = `<button class="del-btn" onclick="event.stopPropagation(); palette.splice(${i},1); updateUI();">Ã—</button>`;
            pList.appendChild(s);
        });

        ['warp', 'weft'].forEach(type => {
            const cont = document.getElementById(type + 'List');
            const data = (type === 'warp') ? warp : weft;
            cont.innerHTML = '';
            data.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = 'thread-item';
                row.innerHTML = `
                    <div class="color-preview" style="background:${t.color}" onclick="openDD(event, '${type}', ${i})"></div>
                    <input type="number" class="width-input" value="${t.width}" oninput="updateWidth('${type}',${i},this.value)">
                `;
                cont.appendChild(row);
            });
        });
        render();
    }

    function openDD(e, type, idx) {
        const menu = document.getElementById('ddMenu');
        menu.style.display = 'grid';
        menu.style.top = (e.pageY + 10) + 'px';
        menu.style.left = (e.pageX + 10) + 'px';
        menu.innerHTML = '';
        palette.forEach(hex => {
            const opt = document.createElement('div');
            opt.className = 'swatch';
            opt.style.background = hex;
            opt.onclick = () => {
                const target = (type === 'warp') ? warp : weft;
                target[idx].color = hex;
                menu.style.display = 'none';
                updateUI();
            };
            menu.appendChild(opt);
        });
    }

    window.onclick = (e) => { if (!e.target.classList.contains('color-preview')) document.getElementById('ddMenu').style.display = 'none'; };

    function updateWidth(type, i, val) {
        const target = (type === 'warp') ? warp : weft;
        target[i].width = parseInt(val) || 1;
        render();
    }

    function addThread(type) {
        const target = (type === 'warp') ? warp : weft;
        target.push({ color: palette[0], width: 20 });
        updateUI();
    }

    function toggleWeft() {
        const linked = document.getElementById('linkWeft').checked;
        const col = document.getElementById('weftCol');
        col.style.opacity = linked ? '0.3' : '1';
        col.style.pointerEvents = linked ? 'none' : 'auto';
        render();
    }

    function render() {
        const zoom = parseInt(document.getElementById('zoom').value);
        const warpSeq = [];
        warp.forEach(t => { for(let i=0; i<t.width; i++) warpSeq.push(t.color); });
        
        const linked = document.getElementById('linkWeft').checked;
        const weftData = linked ? warp : weft;
        const weftSeq = [];
        weftData.forEach(t => { for(let i=0; i<t.width; i++) weftSeq.push(t.color); });

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let x = 0; x < canvas.width / zoom; x++) {
            for (let y = 0; y < canvas.height / zoom; y++) {
                const c1 = warpSeq[x % warpSeq.length] || "#fff";
                const c2 = weftSeq[y % weftSeq.length] || "#fff";
                ctx.fillStyle = blend(c1, c2);
                ctx.fillRect(x * zoom, y * zoom, zoom, zoom);
            }
        }
    }

    function blend(h1, h2) {
        const r1 = parseInt(h1.substr(1,2),16), g1 = parseInt(h1.substr(3,2),16), b1 = parseInt(h1.substr(5,2),16);
        const r2 = parseInt(h2.substr(1,2),16), g2 = parseInt(h2.substr(3,2),16), b2 = parseInt(h2.substr(5,2),16);
        return `rgb(${(r1+r2)/2}, ${(g1+g2)/2}, ${(b1+b2)/2})`;
    }

    function hexToHsl(hex) {
        let r = parseInt(hex.substr(1,2),16)/255, g = parseInt(hex.substr(3,2),16)/255, b = parseInt(hex.substr(5,2),16)/255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if(max == min) h = s = 0;
        else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
    }
    function hslToHex(h, s, l) {
        l /= 100; const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    }
    function rotateHsl(hsl, deg) { return { ...hsl, h: (hsl.h + deg + 360) % 360 }; }
    function lightenHsl(hsl, amt) { return { ...hsl, l: Math.max(0, Math.min(100, hsl.l + amt)) }; }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'plaid.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    previewBase("#4a90e2");
    updateUI();
</script>

</body>
</html>