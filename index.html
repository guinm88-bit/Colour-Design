<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plaid Master Pro</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --panel: #ffffff;
            --border: #cbd5e1;
            --text: #1e293b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg); margin: 0; color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
        }

        /* STICKY PREVIEW (Essential for mobile convenience) */
        .preview-header {
            position: sticky; top: 0; z-index: 1000;
            background: var(--panel); padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        canvas {
            background: #fff; border: 1px solid #94a3b8;
            width: 180px; height: 180px; /* Mobile size */
            image-rendering: pixelated;
        }
        @media (min-width: 900px) {
            canvas { width: 300px; height: 300px; }
            .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* CARDS */
        .card {
            background: var(--panel); border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        h3 { margin-top: 0; font-size: 16px; display: flex; align-items: center; gap: 8px; color: #475569; }

        /* GLOBAL PICKER */
        .global-picker-box { display: flex; align-items: center; gap: 15px; }
        input[type="color"] { width: 50px; height: 50px; border: none; border-radius: 8px; cursor: pointer; }

        /* PALETTE GRID */
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-top: 10px; }
        .p-swatch { 
            width: 100%; aspect-ratio: 1; border-radius: 6px; 
            border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: relative; cursor: pointer;
        }
        .p-swatch .del { 
            position: absolute; top: -5px; right: -5px; background: #ef4444; 
            color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; 
        }

        /* HARMONIES */
        .harmony-section { margin-top: 15px; }
        .h-label { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .h-row { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; }
        .h-item { width: 32px; height: 32px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; cursor: pointer; }

        /* THREADS */
        .thread-row { 
            display: flex; align-items: center; gap: 10px; 
            background: #f8fafc; padding: 8px; border-radius: 8px; margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }
        
        /* THE CUSTOM DROPDOWN */
        .dd-container { position: relative; }
        .dd-trigger { 
            width: 36px; height: 36px; border-radius: 6px; 
            border: 2px solid #fff; box-shadow: 0 0 0 1px #cbd5e1; cursor: pointer; 
        }
        .dd-menu {
            position: absolute; top: 0; left: 45px; z-index: 2000;
            background: #fff; border: 1px solid #94a3b8; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 6px; display: none; grid-template-columns: repeat(3, 1fr); gap: 6px;
            border-radius: 8px; min-width: 110px;
        }
        .dd-menu.active { display: grid; }
        .dd-opt { width: 28px; height: 28px; border-radius: 4px; cursor: pointer; border: 1px solid #eee; }

        .width-input { width: 60px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-weight: bold; }
        .btn-add { width: 100%; padding: 10px; border: 2px dashed var(--primary); background: transparent; color: var(--primary); font-weight: bold; border-radius: 8px; cursor: pointer; }
        
        .controls-footer { display: flex; gap: 10px; margin-top: 10px; width: 100%; max-width: 400px; }
        .btn-save { flex: 1; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="preview-header">
    <canvas id="plaidCanvas" width="600" height="600"></canvas>
    <div class="controls-footer">
        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
            <small>Zoom</small>
            <input type="range" id="zoom" min="2" max="30" value="12" oninput="render()" style="flex: 1;">
        </div>
        <button class="btn-save" onclick="saveImage()">Download PNG</button>
    </div>
</div>

<div class="main-content">
    <!-- COLORS COLUMN -->
    <div class="col">
        <div class="card">
            <h3>1. Color Engine</h3>
            <div class="global-picker-box">
                <input type="color" id="globalPicker" value="#4f46e5" oninput="updateGlobal(this.value)">
                <div>
                    <strong id="hexLabel">#4F46E5</strong><br>
                    <small>Pick a base to see combinations</small>
                </div>
            </div>

            <div class="harmony-section" id="harmonies">
                <!-- Harmony names/swatches injected here -->
            </div>

            <h3 style="margin-top:25px;">2. Active Palette</h3>
            <small>These colors populate your thread selectors</small>
            <div id="paletteList" class="palette-grid"></div>
        </div>
    </div>

    <!-- PATTERN COLUMN -->
    <div class="col">
        <div class="card">
            <h3>3. Thread Pattern</h3>
            <div style="margin-bottom: 15px; font-size: 13px;">
                <label style="cursor: pointer;"><input type="checkbox" id="linkWeft" checked onchange="toggleWeft()"> Use Warp for Weft (Classic Plaid)</label>
            </div>

            <h4 style="font-size: 12px; color: #64748b; text-transform: uppercase;">Warp Threads (Vertical)</h4>
            <div id="warpList"></div>
            <button class="btn-add" onclick="addThread('warp')">+ Add Thread</button>

            <div id="weftGroup" style="display:none; margin-top: 25px;">
                <h4 style="font-size: 12px; color: #64748b; text-transform: uppercase;">Weft Threads (Horizontal)</h4>
                <div id="weftList"></div>
                <button class="btn-add" onclick="addThread('weft')">+ Add Thread</button>
            </div>
        </div>
    </div>
</div>

<script>
    let palette = ["#4F46E5", "#FFFFFF", "#1E293B", "#F43F5E"];
    let warp = [{ color: "#4F46E5", width: 10 }, { color: "#FFFFFF", width: 2 }];
    let weft = [{ color: "#4F46E5", width: 10 }, { color: "#FFFFFF", width: 2 }];

    const canvas = document.getElementById('plaidCanvas');
    const ctx = canvas.getContext('2d');

    function updateGlobal(hex) {
        document.getElementById('hexLabel').innerText = hex.toUpperCase();
        renderHarmonies(hex);
        if(!palette.includes(hex.toUpperCase())) {
            palette.push(hex.toUpperCase());
            updateUI();
        }
    }

    function renderHarmonies(baseHex) {
        const container = document.getElementById('harmonies');
        container.innerHTML = '';
        const hsl = hexToHsl(baseHex);
        
        const types = {
            "Complementary": [rotateHsl(hsl, 180)],
            "Analogous": [rotateHsl(hsl, -30), rotateHsl(hsl, 30)],
            "Triadic": [rotateHsl(hsl, 120), rotateHsl(hsl, 240)],
            "Monochrome": [lightenHsl(hsl, 25), lightenHsl(hsl, -25)]
        };

        for (let name in types) {
            const label = document.createElement('span');
            label.className = 'h-label';
            label.innerText = name;
            container.appendChild(label);

            const row = document.createElement('div');
            row.className = 'h-row';
            types[name].forEach(c => {
                const hex = hslToHex(c.h, c.s, c.l);
                const div = document.createElement('div');
                div.className = 'h-item';
                div.style.background = hex;
                div.onclick = () => {
                    if(!palette.includes(hex)) palette.push(hex);
                    updateUI();
                };
                row.appendChild(div);
            });
            container.appendChild(row);
        }
    }

    function updateUI() {
        // Palette
        const pList = document.getElementById('paletteList');
        pList.innerHTML = '';
        palette.forEach((hex, i) => {
            const div = document.createElement('div');
            div.className = 'p-swatch';
            div.style.background = hex;
            div.innerHTML = `<button class="del" onclick="removePaletteColor(${i})">✕</button>`;
            pList.appendChild(div);
        });

        renderThreadList('warp');
        renderThreadList('weft');
        render();
    }

    function removePaletteColor(i) {
        if(palette.length > 1) {
            palette.splice(i, 1);
            updateUI();
        }
    }

    function renderThreadList(type) {
        const container = document.getElementById(type + 'List');
        const data = (type === 'warp') ? warp : weft;
        container.innerHTML = '';

        data.forEach((t, i) => {
            const row = document.createElement('div');
            row.className = 'thread-row';
            
            let ddItems = '';
            palette.forEach(hex => {
                ddItems += `<div class="dd-opt" style="background:${hex}" onclick="setThreadColor('${type}', ${i}, '${hex}')"></div>`;
            });

            row.innerHTML = `
                <div class="dd-container">
                    <div class="dd-trigger" style="background:${t.color}" onclick="toggleDropdown('${type}', ${i})"></div>
                    <div class="dd-menu" id="dd-${type}-${i}">${ddItems}</div>
                </div>
                <input type="number" class="width-input" value="${t.width}" oninput="updateWidth('${type}', ${i}, this.value)">
                <button onclick="removeThread('${type}', ${i})" style="border:none; background:none; color:#94a3b8; cursor:pointer;">✕</button>
            `;
            container.appendChild(row);
        });
    }

    function toggleDropdown(type, i) {
        document.querySelectorAll('.dd-menu').forEach(m => m.classList.remove('active'));
        document.getElementById(`dd-${type}-${i}`).classList.add('active');
    }

    window.onclick = (e) => {
        if (!e.target.matches('.dd-trigger')) {
            document.querySelectorAll('.dd-menu').forEach(m => m.classList.remove('active'));
        }
    };

    function setThreadColor(type, i, hex) {
        const target = (type === 'warp') ? warp : weft;
        target[i].color = hex;
        updateUI();
    }

    function updateWidth(type, i, val) {
        const target = (type === 'warp') ? warp : weft;
        target[i].width = parseInt(val) || 1;
        render();
    }

    function addThread(type) {
        const target = (type === 'warp') ? warp : weft;
        target.push({ color: palette[0], width: 10 });
        updateUI();
    }

    function removeThread(type, i) {
        const target = (type === 'warp') ? warp : weft;
        if(target.length > 1) target.splice(i, 1);
        updateUI();
    }

    function toggleWeft() {
        document.getElementById('weftGroup').style.display = document.getElementById('linkWeft').checked ? 'none' : 'block';
        render();
    }

    function render() {
        const zoom = parseInt(document.getElementById('zoom').value);
        const warpSeq = [];
        warp.forEach(t => { for(let i=0; i<t.width; i++) warpSeq.push(t.color); });
        
        const weftData = document.getElementById('linkWeft').checked ? warp : weft;
        const weftSeq = [];
        weftData.forEach(t => { for(let i=0; i<t.width; i++) weftSeq.push(t.color); });

        if (!warpSeq.length || !weftSeq.length) return;

        // Draw the check pattern
        for (let x = 0; x < canvas.width / zoom; x++) {
            for (let y = 0; y < canvas.height / zoom; y++) {
                const cWarp = warpSeq[x % warpSeq.length];
                const cWeft = weftSeq[y % weftSeq.length];
                
                // This is the magic: Blend warp and weft to create the "Check"
                ctx.fillStyle = blend(cWarp, cWeft);
                ctx.fillRect(x * zoom, y * zoom, zoom, zoom);
            }
        }
    }

    function blend(hex1, hex2) {
        const r1 = parseInt(hex1.substr(1,2),16), g1 = parseInt(hex1.substr(3,2),16), b1 = parseInt(hex1.substr(5,2),16);
        const r2 = parseInt(hex2.substr(1,2),16), g2 = parseInt(hex2.substr(3,2),16), b2 = parseInt(hex2.substr(5,2),16);
        // 50/50 blend for the overlapping threads
        const r = Math.round((r1 + r2) / 2);
        const g = Math.round((g1 + g2) / 2);
        const b = Math.round((b1 + b2) / 2);
        return `rgb(${r},${g},${b})`;
    }

    // Color Helpers
    function hexToHsl(hex) {
        let r = parseInt(hex.substr(1,2),16)/255, g = parseInt(hex.substr(3,2),16)/255, b = parseInt(hex.substr(5,2),16)/255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if(max == min) h = s = 0;
        else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
    }
    function hslToHex(h, s, l) {
        l /= 100; const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    }
    function rotateHsl(hsl, deg) { return { ...hsl, h: (hsl.h + deg + 360) % 360 }; }
    function lightenHsl(hsl, amt) { return { ...hsl, l: Math.max(0, Math.min(100, hsl.l + amt)) }; }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'plaid-pattern.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    // Init
    renderHarmonies("#4F46E5");
    updateUI();
</script>

</body>
</html>